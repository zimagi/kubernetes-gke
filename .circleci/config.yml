version: '2.1'
orbs:
  terraform: circleci/terraform@1.0.0
jobs:
  gate-job:
    docker:
      - image: circleci/golang:1.17.0
    steps:
      - checkout
      - restore_cache:
          keys:
            - go-mod-v4-{{ checksum "go.sum" }}
      - run:
          name: Install Dependencies
          command: go mod download -x
      - save_cache:
          key: go-mod-v4-{{ checksum "go.sum" }}
          paths:
            - "/go/pkg/mod"
      - run:
          name: Run tests
          command: |
            go test -v -timeout 30m > /tmp/test_result_file.txt
      - store_artifacts:
          path: /tmp/test_result_file.txt
          destination: test_result_file
    working_directory: test
  check-job:
    executor: terraform/default
    steps:
      - checkout
      - terraform/init:
          path: examples/complete
      - terraform/validate:
          path: examples/complete
      - terraform/fmt:
          path: examples/complete
      - terraform/fmt:
          path: .
      - terraform/plan:
          path: examples/complete
workflows:
  terraform-workflow:
    jobs:
      - check-job
      - gate-job:
          requires:
            - check-job
          filters:
            branches:
              only:
                - develop
